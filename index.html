<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Top 10 – Reported Posts Moderation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #ffffff;
      color: #111;
      margin: 0;
      padding: 20px;
    }
    h1 {
      color: #008000;
      text-align: center;
    }
    .post {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #f9f9f9;
      border-radius: 12px;
      padding: 15px;
      margin: 10px auto;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      max-width: 700px;
    }
    .post img {
      max-width: 120px;
      border-radius: 10px;
    }
    .actions button {
      font-size: 18px;
      padding: 6px 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-left: 6px;
    }
    .check {
      background-color: #28a745;
      color: white;
    }
    .delete {
      background-color: #dc3545;
      color: white;
    }
  </style>
</head>
<body>
  <h1>Reported Posts</h1>
  <div id="posts"></div>

  <script>
    const container = document.getElementById("posts");

    const apiToken = "d26980d19c57cf2add6fb54a82da6490feccffeba5852fa80cba456e4dbd229d"; // replace with your token
    const containerID = "iCloud.keyninestudios.topten"; // replace with your container
    const environment = "development"; // or "production"

    async function fetchReportedPosts() {
      const url = `https://api.apple-cloudkit.com/database/1/${containerID}/${environment}/public/records/query?ckAPIToken=${apiToken}`;

      const body = {
        recordType: "ReportedPosts",
        resultsLimit: 50
      };

      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      return data.records || [];
    }

    async function fetchPhotoEntry(postRecordName) {
      const url = `https://api.apple-cloudkit.com/database/1/${containerID}/${environment}/public/records/lookup?ckAPIToken=${apiToken}`;

      const body = { records: [{ recordName: postRecordName }] };

      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      const data = await res.json();
      return data.records && data.records[0];
    }

    async function updateReportedPostStatus(recordName, status) {
      const url = `https://api.apple-cloudkit.com/database/1/${containerID}/${environment}/public/records/modify?ckAPIToken=${apiToken}`;
      const body = {
        operations: [{
          operationType: "update",
          record: {
            recordName,
            recordType: "ReportedPosts",
            fields: {
              status: { value: status }
            }
          }
        }]
      };

      return fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
    }

    async function deletePhoto(recordName) {
      const url = `https://api.apple-cloudkit.com/database/1/${containerID}/${environment}/public/records/modify?ckAPIToken=${apiToken}`;
      const body = {
        operations: [{
          operationType: "delete",
          record: { recordName }
        }]
      };

      return fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
    }

    async function render() {
      const reported = await fetchReportedPosts();
      for (const report of reported) {
        const postRecordName = report.fields?.postRecordName?.value;
        const photoEntry = await fetchPhotoEntry(postRecordName);

        const div = document.createElement("div");
        div.className = "post";

        const info = document.createElement("div");
        info.innerHTML = `
          <p><b>Reported Post:</b> ${postRecordName}</p>
          ${photoEntry?.fields?.photo?.value?.downloadURL 
            ? `<img src="${photoEntry.fields.photo.value.downloadURL}" alt="Photo"/>`
            : "<p>No photo found.</p>"}
        `;

        const actions = document.createElement("div");
        actions.className = "actions";

        const checkBtn = document.createElement("button");
        checkBtn.textContent = "✅";
        checkBtn.className = "check";
        checkBtn.onclick = async () => {
          await updateReportedPostStatus(report.recordName, "Closed - No Action");
          div.remove();
        };

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "❌";
        deleteBtn.className = "delete";
        deleteBtn.onclick = async () => {
          if (photoEntry) {
            await deletePhoto(photoEntry.recordName);
          }
          await updateReportedPostStatus(report.recordName, "Removed");
          div.remove();
        };

        actions.appendChild(checkBtn);
        actions.appendChild(deleteBtn);

        div.appendChild(info);
        div.appendChild(actions);
        container.appendChild(div);
      }
    }

    render();
  </script>
</body>
</html>
